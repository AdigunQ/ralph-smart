# Oracle Price Manipulation

## Description

Smart contracts relying on on-chain price oracles (especially DEX spot prices) can be manipulated via flash loans or large trades within a single transaction.

## Severity

**CRITICAL** - Can lead to massive theft or protocol insolvency

## Impact

- Borrow assets at manipulated prices
- Liquidate healthy positions
- Drain liquidity pools
- Protocol insolvency

## Vulnerable Pattern

```solidity
contract VulnerableLending {
    IUniswapV2Pair public oracle;  // ❌ Using DEX spot price

    function getCollateralValue(address token, uint amount) public view returns (uint) {
        (uint reserve0, uint reserve1, ) = oracle.getReserves();
        uint price = reserve1 / reserve0;  // Spot price!
        return amount * price;
    }

    function borrow(uint amount) external {
        uint collateralValue = getCollateralValue(userToken, userCollateralAmount);
        require(collateralValue >= amount * 150 / 100);  // 150% collateral ratio
        // ❌ Attacker can manipulate price in same block
        lend(amount);
    }
}
```

## Attack Scenario

```solidity
1. Flash loan 10,000 ETH
2. Swap ETH → USDC in target DEX pool (price crashes)
3. Use manipulated price to borrow max USDC from lending protocol
4. Swap back USDC → ETH (restore price)
5. Repay flash loan + profit
```

## Detection Strategy

### Code to Search For

```solidity
// Dangerous patterns:
getReserves()           // Uniswap V2 spot price
slot0()                 // Uniswap V3 spot price
latestAnswer()          // Chainlink (check if stale)
balanceOf() / totalSupply  // LP token price calculation
```

### Questions

1. Does the contract use DEX reserves for pricing?
2. Is there a TWAP (Time-Weighted Average Price)?
3. Can price be influenced in a single block?
4. Are there checks for price deviation/manipulation?

## Mitigation

### 1. Use Chainlink Price Feeds

```solidity
import "@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol";

contract Secure {
    AggregatorV3Interface public priceFeed;

    function getPrice() public view returns (uint) {
        (, int price, , uint timeStamp, ) = priceFeed.latestRoundData();
        require(block.timestamp - timeStamp < 3600, "Stale price");
        return uint(price);
    }
}
```

### 2. Use TWAP Oracles

```solidity
// Uniswap V3 TWAP example
uint32[] memory secondsAgo = new uint32[](2);
secondsAgo[0] = 1800;  // 30 minutes ago
secondsAgo[1] = 0;      // now

(int56[] memory tickCumulatives, ) = pool.observe(secondsAgo);
int56 tickCumulativesDelta = tickCumulatives[1] - tickCumulatives[0];
int24 avgTick = int24(tickCumulativesDelta / 1800);
```

### 3. Price Deviation Checks

```solidity
uint currentPrice = getCurrentPrice();
uint twapPrice = getTWAPPrice();
require(abs(currentPrice - twapPrice) < twapPrice * 5 / 100, "Price manipulation detected");
```

## Real-World Examples

- **Harvest Finance (2020)**: $34M via flash loan price manipulation
- **Cream Finance (2021)**: $130M using manipulated LP token prices
- **Mango Markets (2022)**: $110M oracle manipulation

## References

- [Smart Contract Weakness Classification: Oracle Manipulation](https://swcregistry.io/docs/SWC-136)
- [Euler Finance Price Oracle Best Practices](https://docs.euler.finance/risk-framework/price-oracle-concerns)
