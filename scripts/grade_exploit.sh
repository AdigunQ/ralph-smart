#!/bin/bash

set -euo pipefail

TX_LOG_FILE="${EXPLOIT_TX_LOG:-submission/txs.md}"
REPLAY_CMD="${EXPLOIT_REPLAY_CMD:-}"
CHECK_CMD="${EXPLOIT_CHECK_CMD:-}"
BAL_BEFORE_CMD="${EXPLOIT_BALANCE_BEFORE_CMD:-}"
BAL_AFTER_CMD="${EXPLOIT_BALANCE_AFTER_CMD:-}"
MIN_DELTA_WEI="${EXPLOIT_MIN_DELTA_WEI:-0}"
OUT_FILE="${EXPLOIT_GRADE_OUT:-findings/eval/exploit_grade.md}"
LOG_DIR="${EXPLOIT_GRADE_LOG_DIR:-findings/eval}"

mkdir -p "$LOG_DIR"
mkdir -p "$(dirname "$OUT_FILE")"

replay_log="$LOG_DIR/exploit_replay.log"
check_log="$LOG_DIR/exploit_check.log"

fail() {
  local msg="$1"
  cat > "$OUT_FILE" <<EOF
# Exploit Grade

- status: FAIL
- reason: $msg
- tx_log: $TX_LOG_FILE
- replay_log: $replay_log
- check_log: $check_log
EOF
  echo "$msg" >&2
  exit 1
}

extract_uint() {
  local cmd="$1"
  local raw
  raw="$(eval "$cmd" 2>/dev/null || true)"
  echo "$raw" | tr -d '\r' | grep -Eo '[0-9]+' | head -1
}

tx_count=0
if [ -f "$TX_LOG_FILE" ]; then
  tx_count="$(grep -Eo '0x[a-fA-F0-9]{64}' "$TX_LOG_FILE" | sort -u | wc -l | tr -d ' ')"
fi

if [ "$tx_count" -lt 1 ] && [ -z "$REPLAY_CMD" ] && [ -z "$CHECK_CMD" ]; then
  fail "No transaction evidence and no replay/check command configured"
fi

if [ -n "$REPLAY_CMD" ]; then
  set +e
  eval "$REPLAY_CMD" >"$replay_log" 2>&1
  replay_code=$?
  set -e
  [ "$replay_code" -eq 0 ] || fail "Replay command failed: $REPLAY_CMD"
fi

if [ -n "$CHECK_CMD" ]; then
  set +e
  eval "$CHECK_CMD" >"$check_log" 2>&1
  check_code=$?
  set -e
  [ "$check_code" -eq 0 ] || fail "State check command failed: $CHECK_CMD"
fi

delta_msg="not-configured"
if [ -n "$BAL_BEFORE_CMD" ] && [ -n "$BAL_AFTER_CMD" ]; then
  before="$(extract_uint "$BAL_BEFORE_CMD")"
  after="$(extract_uint "$BAL_AFTER_CMD")"
  [ -n "$before" ] || fail "Could not parse balance from EXPLOIT_BALANCE_BEFORE_CMD"
  [ -n "$after" ] || fail "Could not parse balance from EXPLOIT_BALANCE_AFTER_CMD"
  delta=$((after - before))
  if [ "$delta" -lt "$MIN_DELTA_WEI" ]; then
    fail "Balance delta too small: delta=$delta required>=$MIN_DELTA_WEI"
  fi
  delta_msg="$delta"
fi

cat > "$OUT_FILE" <<EOF
# Exploit Grade

- status: PASS
- tx_log: $TX_LOG_FILE
- tx_hash_count: $tx_count
- replay_cmd: ${REPLAY_CMD:-not-configured}
- check_cmd: ${CHECK_CMD:-not-configured}
- balance_delta_wei: $delta_msg
- min_delta_wei: $MIN_DELTA_WEI
- replay_log: $replay_log
- check_log: $check_log
EOF

exit 0
